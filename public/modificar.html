<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Modificar Usuario</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="header-placeholder"></div>
  <main>
  <h2>Modificar Usuario</h2>
  <form id="modificarForm">
    <input type="text" name="username" placeholder="Usuario" required><br>
    <input type="password" name="password" placeholder="Nueva clave"><br>
    <input type="email" name="email" placeholder="Email"><br>
    <div id="rolesContainer"></div><br>
    <input type="text" name="rol" value="subscriber" readonly><br>
    <input type="text" name="cod_profesional" placeholder="Código profesional"><br>
    <input type="text" name="nombre" placeholder="Nombre"><br>
    <input type="text" name="apellido" placeholder="Apellido"><br>
    <input type="text" name="alias" placeholder="Alias" readonly><br>
    <button type="submit">Guardar</button>
  </form>
  </main>
  <div id="footer-placeholder"></div>
  <script type="module">
    import { cargarRolesSuite } from './cargarRolesSuite.js';

    let rolesDisponibles = [];
    const rolesContainer = document.getElementById('rolesContainer');

    async function fetchRolesDisponibles() {
      const res = await fetch('/api/usuarios/roles_suite');
      rolesDisponibles = await res.json();
    }

    function crearSelectRol(valorInicial = "") {
      const select = document.createElement('select');
      select.className = 'select-rol';
      select.name = 'roles_suite[]';

      const defaultOption = document.createElement('option');
      defaultOption.value = "";
      defaultOption.textContent = "— Seleccione un rol —";
      select.appendChild(defaultOption);

      rolesDisponibles.forEach((rol) => {
        const option = document.createElement('option');
        option.value = rol.value;
        option.textContent = rol.label;
        if (rol.value == valorInicial) option.selected = true;
        select.appendChild(option);
      });

      select.addEventListener('change', () => {
        const selects = Array.from(rolesContainer.querySelectorAll('select'));
        const values = selects.map(s => s.value).filter(v => v !== "");
        if (values.length === selects.length) crearSelectRol();
      });

      rolesContainer.appendChild(select);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchRolesDisponibles();
      cargarRolesSuite();

      const form = document.getElementById('modificarForm');

      const actualizarAlias = () => {
        const nombre = form.nombre.value.trim();
        const apellido = form.apellido.value.trim();
        form.alias.value = `${nombre} ${apellido}`.trim();
      };
      form.nombre.addEventListener('input', actualizarAlias);
      form.apellido.addEventListener('input', actualizarAlias);

      const params = new URLSearchParams(window.location.search);
      const userParam = params.get("username");

      if (userParam) {
        const user = encodeURIComponent(userParam.trim());
        try {
          const res = await fetch(`/api/usuarios/${user}`);
          if (res.ok) {
            const u = await res.json();
            form.username.value = u.username || '';
            form.password.value = ''; // Nunca mostrar contraseña
            form.email.value = u.email || '';
            form.rol.value = u.rol || '';
            form.cod_profesional.value = u.cod_profesional || '';
            form.nombre.value = u.nombre || '';
            form.apellido.value = u.apellido || '';
            form.alias.value = u.alias || '';

            // Cargar roles actuales
            const rolesActuales = u.rol_suite || ''; // por ejemplo: "4,26"
            const listaRoles = rolesActuales.split(',').filter(Boolean);
            listaRoles.forEach(r => crearSelectRol(r));
            crearSelectRol(); // uno vacío extra
          }
        } catch (err) {
          form.username.value = userParam.trim();
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        const rolesSeleccionados = Array.from(document.querySelectorAll('.select-rol'))
          .map(s => s.value)
          .filter(v => v !== "");

        formData.set("rol_suite", rolesSeleccionados.join(','));

        const datos = Object.fromEntries(formData.entries());

        const res = await fetch('/api/usuarios/modificar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });

        if (res.ok) {
          alert("Usuario modificado");
        } else {
          alert("Error al modificar");
        }
      });
    });
  </script>
  <script src="header.js"></script>
  <script src="logout.js"></script>
</body>
</html>

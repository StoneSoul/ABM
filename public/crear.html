<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Usuario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="header.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>
  <main class="flex-1 p-4 max-w-7xl mx-auto w-full">
    <div class="w-full max-w-2xl bg-white shadow-md rounded-lg p-8">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Crear Nuevo Usuario</h2>
      <form id="crearForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="username" class="block text-sm font-medium text-gray-600">Usuario</label>
            <input type="text" name="username" id="username" required
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-600">Clave</label>
            <input type="password" name="password" id="password" required
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-600">Email</label>
            <input type="email" name="email" id="email" required
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="rol" class="block text-sm font-medium text-gray-600">Rol WordPress</label>
            <select name="rol" id="rol" class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
              <option value="subscriber" selected>Subscriber</option>
              <option value="administrator">Administrator</option>
            </select>
          </div>
          <div class="md:col-span-2" id="rolesContainer"></div>
          <div>
            <label for="cod_profesional" class="block text-sm font-medium text-gray-600">CÃ³digo Profesional</label>
            <input type="text" name="cod_profesional" id="cod_profesional"
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-600">Nombre</label>
            <input type="text" name="nombre" id="nombre"
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="apellido" class="block text-sm font-medium text-gray-600">Apellido</label>
            <input type="text" name="apellido" id="apellido"
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="md:col-span-2">
            <label for="alias" class="block text-sm font-medium text-gray-600">Alias</label>
            <input type="text" name="alias" id="alias"
                   class="mt-1 w-full border-gray-300 rounded-md px-4 py-2 border focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="pt-4 text-center">
          <button type="submit"
                  class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700 transition duration-300">
            Guardar Usuario
          </button>
        </div>
      </form>
    </div>

    <script src="cargarRolesSuite.js"></script>
    <script>
      document.getElementById('crearForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.rol_suite = formData.get('rol_suite')?.split(',').filter(Boolean) || [];
        const res = await fetch('/api/usuarios/crear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          alert('Usuario creado correctamente');
          e.target.reset();
        } else {
          alert('Error al crear el usuario');
        }
      });
    </script>
    
    <script type="module">
      let rolesDisponibles = [];

      async function fetchRolesDisponibles() {
        const res = await fetch('/api/usuarios/roles_suite');
        const rawRoles = await res.json();
        rolesDisponibles = rawRoles.map(r => ({
          value: String(r.value),
          label: r.label
        }));
      }

      function crearSelectRol(valoresIniciales = []) {
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-4';

        const label = document.createElement('label');
        label.textContent = 'Roles Suite';
        label.className = 'block text-sm font-medium text-gray-600 mb-1';
        wrapper.appendChild(label);

        const contenedor = document.createElement('div');
        contenedor.className = 'rounded-md border border-gray-300 bg-white p-4';

        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'flex flex-wrap gap-2 mb-3';
        contenedor.appendChild(tagsContainer);

        const opcionesContainer = document.createElement('div');
        opcionesContainer.className = 'max-h-64 overflow-y-auto space-y-1';
        contenedor.appendChild(opcionesContainer);

        const valoresSeleccionados = new Set(valoresIniciales.map(String));

        const inputHidden = document.createElement('input');
        inputHidden.type = 'hidden';
        inputHidden.name = 'rol_suite';
        contenedor.appendChild(inputHidden);

        function actualizarTags() {
          tagsContainer.innerHTML = '';
          valoresSeleccionados.forEach((val) => {
            const rol = rolesDisponibles.find((r) => r.value === val);
            if (rol) {
              const tag = document.createElement('span');
              tag.className = 'bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2';
              tag.textContent = rol.label;

              const btn = document.createElement('button');
              btn.innerHTML = '&times;';
              btn.className = 'ml-2 text-blue-500 hover:text-red-600 font-bold';
              btn.onclick = () => {
                valoresSeleccionados.delete(val);
                actualizarTags();
                actualizarCheckboxes();
                actualizarHiddenInput();
              };

              tag.appendChild(btn);
              tagsContainer.appendChild(tag);
            }
          });
        }

        function actualizarCheckboxes() {
          const checkboxes = opcionesContainer.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach((cb) => {
            cb.checked = valoresSeleccionados.has(cb.value);
          });
        }

        function actualizarHiddenInput() {
          inputHidden.value = Array.from(valoresSeleccionados).join(',');
        }

        rolesDisponibles.forEach((rol) => {
          const label = document.createElement('label');
          label.className = 'flex items-center gap-2 text-sm text-gray-700';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = rol.value;
          checkbox.checked = valoresSeleccionados.has(rol.value);
          checkbox.className = 'form-checkbox h-4 w-4 text-blue-600';

          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              valoresSeleccionados.add(checkbox.value);
            } else {
              valoresSeleccionados.delete(checkbox.value);
            }
            actualizarTags();
            actualizarHiddenInput();
          });

          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(rol.label));
          opcionesContainer.appendChild(label);
        });

        actualizarTags();
        actualizarHiddenInput();

        wrapper.appendChild(contenedor);
        return wrapper;
      }

      // Cargar roles y renderizar el componente
      await fetchRolesDisponibles();
      const container = document.getElementById('rolesContainer');
      container.appendChild(crearSelectRol([]));

    </script>
  </main>
  <div id="footer-placeholder"></div>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Usuarios</title>
  <link rel="icon" href="/favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="header.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>
  <main class="flex-1 p-4 max-w-7xl mx-auto w-full">
    <h2 class="text-3xl font-bold text-center mb-6 text-gray-700">Usuarios</h2>

    <input type="text" id="buscador" placeholder="Buscar usuarios..."
           class="mb-4 w-full max-w-md mx-auto block border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500" />

    <!-- Tabla responsive sin scroll horizontal -->
    <div class="rounded-lg shadow-lg border border-gray-200 bg-white w-full">
      <table id="tablaUsuarios" class="table-auto w-full text-sm text-gray-800">
        <thead class="bg-gray-200 text-gray-700 uppercase text-xs tracking-wider">
          <tr>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(0)">Usuario</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(1)">Email</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(2)">Nombre completo</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(3)">Rol WP</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(4)">Rol Suite</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(5)">Código Profesional</th>
            <th class="px-2 py-3 text-left cursor-pointer" onclick="ordenar(6)">Estado</th>
            <th class="px-2 py-3 text-center">Acción</th>
            <th class="px-2 py-3 text-center">Editar</th>
          </tr>
        </thead>
        <tbody id="contenidoTabla" class="divide-y divide-gray-100">
          <!-- generado dinámicamente -->
        </tbody>
      </table>
      <div id="paginacion" class="mt-4 flex justify-center space-x-2"></div>
    </div>

    <dialog id="rolesDialog" class="p-4 bg-white rounded-md shadow-lg">
      <h3 class="text-lg font-semibold mb-2">Roles asignados</h3>
      <ul id="rolesList" class="list-disc list-inside"></ul>
      <div class="text-right mt-4">
        <button id="closeDialog" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Cerrar</button>
      </div>
    </dialog>

    <script>
      let rolesMap = {};

      async function cargarRolesSuite() {
        if (Object.keys(rolesMap).length) return;
        const res = await fetch('/api/usuarios/roles_suite');
        const datos = await res.json();
        datos.forEach(r => {
          rolesMap[String(r.value)] = r.label;
        });
      }

      function mostrarRoles(codigos) {
        const dialog = document.getElementById('rolesDialog');
        const lista = document.getElementById('rolesList');
        lista.innerHTML = '';
        if (!codigos) {
          const li = document.createElement('li');
          li.textContent = 'Sin roles';
          lista.appendChild(li);
        } else {
          codigos.split(',').map(c => c.trim()).filter(Boolean).forEach(id => {
            const li = document.createElement('li');
            li.textContent = rolesMap[id] || id;
            lista.appendChild(li);
          });
        }
        dialog.showModal();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('closeDialog').addEventListener('click', () => {
          document.getElementById('rolesDialog').close();
        });
      });

      async function cargarUsuarios(pagina = 1) {
        await cargarRolesSuite();
        const searchInput = document.getElementById('buscador');
        const filtro = searchInput.value || '';

        const res = await fetch(`/api/usuarios?page=${pagina}&limit=10&search=${encodeURIComponent(filtro)}`);
        const json = await res.json();
        const datos = json.datos;        const tbody = document.getElementById('contenidoTabla');
        tbody.innerHTML = '';

        for (const u of datos) {
          const fila = document.createElement('tr');
          const estaActivo = u.estado === '1' || u.estado === 1 || u.estado === 'activo';

          const td = (text) => {
            const cell = document.createElement('td');
            cell.className = "px-2 py-2 break-words";
            cell.textContent = text;
            return cell;
          };

          fila.appendChild(td(u.username));
          fila.appendChild(td(u.email));
          fila.appendChild(td(u.nombre_completo));
          fila.appendChild(td(u.rol));

          const rolTd = document.createElement('td');
          rolTd.className = 'px-2 py-2 text-center';
          const verBtn = document.createElement('button');
          verBtn.textContent = 'Ver';
          verBtn.className = 'bg-blue-500 text-white px-2 py-1 text-sm rounded hover:bg-blue-600';
          verBtn.onclick = () => mostrarRoles(u.rol_suite);
          rolTd.appendChild(verBtn);
          fila.appendChild(rolTd);

          fila.appendChild(td(u.cod_profesional));
          fila.appendChild(td(estaActivo ? 'Activo' : 'Inactivo'));

          const accion = document.createElement('td');
          accion.className = "px-2 py-2 text-center";
          const btn = document.createElement('button');
          btn.textContent = estaActivo ? 'Desactivar' : 'Activar';
          btn.className = estaActivo
            ? 'bg-red-500 text-white px-2 py-1 text-sm rounded hover:bg-red-600'
            : 'bg-green-500 text-white px-2 py-1 text-sm rounded hover:bg-green-600';
          btn.onclick = async () => {
            if (!confirm(`¿Deseas ${btn.textContent.toLowerCase()} este usuario?`)) return;
            const res = await fetch('/api/usuarios/estado', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: u.username, estado: estaActivo ? 0 : 1 })
            });
            if (res.ok) cargarUsuarios(pagina);
          };
          accion.appendChild(btn);
          fila.appendChild(accion);

          const editar = document.createElement('td');
          editar.className = "px-2 py-2 text-center";
          const link = document.createElement('a');
          link.href = `/modificar.html?username=${encodeURIComponent(u.username)}`;
          link.textContent = 'Editar';
          link.className = 'text-blue-600 hover:underline';
          editar.appendChild(link);
          fila.appendChild(editar);

          tbody.appendChild(fila);
        }

        // Renderizamos paginación
        renderPaginacion(json.pagina, json.limite, json.total);
      }

      function ordenar(columna) {
        const tabla = document.getElementById("tablaUsuarios");
        const filas = Array.from(tabla.tBodies[0].rows);
        const asc = !tabla.dataset.orden || tabla.dataset.orden === "desc";

        filas.sort((a, b) => {
          const valA = a.cells[columna].textContent.trim().toLowerCase();
          const valB = b.cells[columna].textContent.trim().toLowerCase();
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });

        tabla.dataset.orden = asc ? "asc" : "desc";
        const cuerpo = tabla.tBodies[0];
        cuerpo.innerHTML = "";
        filas.forEach(f => cuerpo.appendChild(f));
      }

      document.getElementById('buscador').addEventListener('input', (e) => {
        const filtro = e.target.value;
        cargarUsuarios(1); // siempre cargamos página 1 al cambiar el buscador
      });

      function renderPaginacion(pagina, limite, total) {
        const pagDiv = document.getElementById('paginacion');
        pagDiv.innerHTML = '';

        const totalPaginas = Math.ceil(total / limite);
        if (totalPaginas <= 1) return; // no mostramos si hay 1 página

        const crearBoton = (text, targetPage, activo = false) => {
          const btn = document.createElement('button');
          btn.textContent = text;
          btn.className = `px-3 py-1 rounded ${activo ? 'bg-blue-500 text-white mb-2' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 mb-2'}`;
          btn.onclick = () => cargarUsuarios(targetPage);
          return btn;
        };

        // Botón Primera página
        if (pagina > 1) pagDiv.appendChild(crearBoton('<<', 1));

        // Determinar rango de páginas visibles (máx. 6)
        let start = Math.max(1, pagina - 3);
        let end = Math.min(totalPaginas, start + 6);
        if (end - start < 6) start = Math.max(1, end - 6);

        for (let i = start; i <= end; i++) {
          pagDiv.appendChild(crearBoton(i, i, i === pagina));
        }

        // Botón Última página
        if (pagina < totalPaginas) pagDiv.appendChild(crearBoton('>>', totalPaginas));

        // Indicador de página
        const info = document.createElement('span');
        info.textContent = ` Página ${pagina} de ${totalPaginas} `;
        info.className = 'px-2 text-gray-700';
        pagDiv.prepend(info);
      }

      cargarUsuarios();
    </script>
  </main>
  <div id="footer-placeholder"></div>
</body>
</html>
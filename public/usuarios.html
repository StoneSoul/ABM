<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Listado de Usuarios</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input[type="text"] {
      width: 300px; padding: 8px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    table {
      border-collapse: collapse; width: 100%;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px;
    }
    th {
      background-color: #00414a; color: white;
      cursor: pointer;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <h2>Usuarios Importados</h2>
  <input type="text" id="buscador" placeholder="Buscar usuarios...">

  <table id="tablaUsuarios">
    <thead>
      <tr>
        <th onclick="ordenar(0)">Usuario</th>
        <th onclick="ordenar(1)">Email</th>
        <th onclick="ordenar(2)">Nombre completo</th>
        <th onclick="ordenar(3)">Rol_WP</th>
        <th onclick="ordenar(4)">Rol_Suite</th>
        <th onclick="ordenar(5)">Código Profesional</th>
        <th onclick="ordenar(6)">Estado</th>
        <th>Acción</th>
        <th>Editar</th>
      </tr>
    </thead>
    <tbody id="contenidoTabla"></tbody>
  </table>

  <script>
    async function cargarUsuarios() {
      const res = await fetch('/api/usuarios');
      const datos = await res.json();
      const tbody = document.getElementById('contenidoTabla');
      tbody.innerHTML = '';

      for (const u of datos) {
        const fila = document.createElement('tr');

        const username = document.createElement('td');
        username.textContent = u.username;
        fila.appendChild(username);

        const email = document.createElement('td');
        email.textContent = u.email;
        fila.appendChild(email);

        const nombreCompleto = document.createElement('td');
        nombreCompleto.textContent = u.nombre_completo;
        fila.appendChild(nombreCompleto);

        const rol = document.createElement('td');
        rol.textContent = u.rol;
        fila.appendChild(rol);

        const rol_suite = document.createElement('td');
        rol_suite.textContent = u.rol_suite;
        fila.appendChild(rol_suite);

        const codProfesional = document.createElement('td');
        codProfesional.textContent = u.cod_profesional;
        fila.appendChild(codProfesional);

        const estado = document.createElement('td');
        estado.textContent = u.estado === 1 ? 'Activo' : 'Inactivo';
        fila.appendChild(estado);

        const accion = document.createElement('td');
        const btnEstado = document.createElement('button');
        btnEstado.textContent = u.estado === 1 ? 'Deshabilitar' : 'Habilitar';
        btnEstado.onclick = () => toggleEstado(u.username, u.estado);
        accion.appendChild(btnEstado);
        fila.appendChild(accion);

        const editar = document.createElement('td');
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = () => editarUsuario(u.username);
        editar.appendChild(btnEditar);
        fila.appendChild(editar);

        tbody.appendChild(fila);
      }
    }

    async function toggleEstado(username, estado) {
      const nuevo = estado === 1 ? 0 : 1;
      const res = await fetch('/api/usuarios/estado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, estado: nuevo })
      });
      if (res.ok) {
        cargarUsuarios();
      } else {
        alert('No se pudo cambiar el estado');
      }
    }

    document.getElementById('buscador').addEventListener('input', function() {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tablaUsuarios tbody tr');
      filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        fila.style.display = texto.includes(filtro) ? '' : 'none';
      });
    });

    function ordenar(columna) {
      const filas = Array.from(document.querySelectorAll('#tablaUsuarios tbody tr'));
      const ascendente = !this.ascendente;
      this.ascendente = ascendente;

      filas.sort((a, b) => {
        const valA = a.children[columna].textContent.toLowerCase();
        const valB = b.children[columna].textContent.toLowerCase();
        return ascendente ? valA.localeCompare(valB) : valB.localeCompare(valA);
      });

      const tbody = document.getElementById('contenidoTabla');
      tbody.innerHTML = '';
      filas.forEach(f => tbody.appendChild(f));
    }

    function editarUsuario(username) {
      window.location.href = `modificar.html?username=${username}`;
    }
    cargarUsuarios();
  </script>
  <script src="header.js"></script>
  <script src="logout.js"></script>
</body>
</html>

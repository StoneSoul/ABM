<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="header.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>
  <main class="flex-1 p-4 max-w-7xl mx-auto w-full">
    <h2 class="text-3xl font-bold text-center mb-6 text-gray-700">Usuarios</h2>

    <input type="text" id="buscador" placeholder="Buscar usuarios..."
           class="mb-4 w-full max-w-md mx-auto block border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500" />

           <div class="rounded-lg shadow-lg border border-gray-200 bg-white w-full">
            <table id="tablaUsuarios" class="table-auto w-full text-sm text-gray-800">
        <thead class="bg-gray-200 text-gray-700 uppercase text-xs tracking-wider">
          <tr>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(0)">Usuario</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(1)">Email</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(2)">Nombre completo</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(3)">Rol WP</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(4)">Rol Suite</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(5)">Código Profesional</th>
            <th class="px-4 py-3 text-left cursor-pointer" onclick="ordenar(6)">Estado</th>
            <th class="px-4 py-3 text-center">Acción</th>
            <th class="px-4 py-3 text-center">Editar</th>
          </tr>
        </thead>
        <tbody id="contenidoTabla" class="divide-y divide-gray-100">
          <!-- generado dinámicamente -->
        </tbody>
      </table>
    </div>

    <script>
      async function cargarUsuarios() {
        const res = await fetch('/api/usuarios');
        const datos = await res.json();
        const tbody = document.getElementById('contenidoTabla');
        tbody.innerHTML = '';

        for (const u of datos) {
          const fila = document.createElement('tr');

          const estaActivo = u.estado === '1' || u.estado === 1 || u.estado === 'activo';

          const td = (text) => {
            const cell = document.createElement('td');
            cell.className = "px-4 py-2";
            cell.textContent = text;
            return cell;
          };

          fila.appendChild(td(u.username));
          fila.appendChild(td(u.email));
          fila.appendChild(td(u.nombre_completo));
          fila.appendChild(td(u.rol));
          fila.appendChild(td(u.rol_suite));
          fila.appendChild(td(u.cod_profesional));
          fila.appendChild(td(estaActivo ? 'Activo' : 'Inactivo'));

          // Acción: activar/desactivar
          const accion = document.createElement('td');
          accion.className = "px-4 py-2 text-center";
          const btn = document.createElement('button');
          btn.textContent = estaActivo ? 'Desactivar' : 'Activar';
          btn.className = estaActivo
            ? 'bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600'
            : 'bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600';
          btn.onclick = async () => {
            const confirmacion = confirm(`¿Deseas ${btn.textContent.toLowerCase()} este usuario?`);
            if (!confirmacion) return;
            const res = await fetch(`/api/usuarios/${u.id}/estado`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ estado: estaActivo ? 'inactivo' : 'activo' })
            });
            if (res.ok) cargarUsuarios();
          };
          accion.appendChild(btn);
          fila.appendChild(accion);

          // Editar
          const editar = document.createElement('td');
          editar.className = "px-4 py-2 text-center";
          const link = document.createElement('a');
          link.href = `/modificar.html?username=${encodeURIComponent(u.username)}`;
          link.textContent = 'Editar';
          link.className = 'text-blue-600 hover:underline';
          editar.appendChild(link);
          fila.appendChild(editar);

          tbody.appendChild(fila);
        }
      }

      function ordenar(columna) {
        const tabla = document.getElementById("tablaUsuarios");
        const filas = Array.from(tabla.tBodies[0].rows);
        const asc = !tabla.dataset.orden || tabla.dataset.orden === "desc";

        filas.sort((a, b) => {
          const valA = a.cells[columna].textContent.trim().toLowerCase();
          const valB = b.cells[columna].textContent.trim().toLowerCase();
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });

        tabla.dataset.orden = asc ? "asc" : "desc";
        const cuerpo = tabla.tBodies[0];
        cuerpo.innerHTML = "";
        filas.forEach(f => cuerpo.appendChild(f));
      }

      document.getElementById('buscador').addEventListener('input', (e) => {
        const filtro = e.target.value.toLowerCase();
        const filas = document.querySelectorAll('#contenidoTabla tr');
        filas.forEach(fila => {
          const texto = fila.textContent.toLowerCase();
          fila.style.display = texto.includes(filtro) ? '' : 'none';
        });
      });

      cargarUsuarios();
    </script>
  </main>
  <div id="footer-placeholder"></div>
</body>
</html>
